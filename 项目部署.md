### 前端部署 （`bitbro-backend-website`)

-------

1.**远程登录**：

- **IP**: 163
- **用户**：root
- **密码**：

2.**创建目录**：

- ```sh
  mkdir -p /data/git-source/script #脚本目录
  chown -R root.ubuntu /data/
  ```

3.**更新代码**：

- **运行脚本**：

  ```sh
  ./data/git-source/script/setup-backend-website-repository.sh #从git更新代码，脚本需要配置
  ```

4.**部署应用**：

- **配置文件**：`Dockerfile`、`docker-compose.yml`。按需要修改。

- **运行脚本**：

  ```sh
  ./data/git-source/script/setup-linux.sh #第一次部署安装环境到服务器
  ./data/git-source/script/setup-backend-website.sh #创建前端应用的镜像、容器并启动前端应用
  ```

5.**运行维护**：

- ```sh
  docker ps #查看容器状态
  docker logs <container ID> #查看应用日志
  docker logs -f <container ID> #动态查看日志
  ```

--------

-------



### 后端部署（`bitbro-spring-server`)

--------

1.**更新代码**：

- **运行脚本**：

  ```sh
  ./data/git-source/script/setup-spring-repository.sh
  ```

  

2.**部署应用**

- **运行脚本**

  ```sh
  ./data/git-source/script/setup-spring-server.sh #创建所有应用的镜像、容器以及启动应用
  ```

3.**运行维护**

```sh
docker ps #查看容器状态
docker logs <container ID> #查看应用日志
docker logs -f <container ID> #动态查看日志
```

----

----

### Farbic部署（`bitbro-fabric-main`)

-----

*远程登录(`from 163)* ：

- `master node`：

  - ```sh
    ssh root@72
    ```

- `server node`：

  - ```sh
    ssh root@76
    ```

- `passCode`：

1.**安装k3s集群**（`master node`）：

```sh
apt update

curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn sh -

mkdir -p ~/.kube

sudo ln -s /etc/rancher/k3s/k3s.yaml ~/.kube/config

sudo chmod 666 ~/.kube/config

alias k="k3s kubectl"

k get no #查看节点状态

cat /var/lib/rancher/k3s/server/node-token #获取节点token
```

2.**安装k3s集群**（`server node`）：

```sh
apt update

curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn K3S_URL= {MASTER_NODE_IP:6443}
K3S_TOKEN={MASTER_NODE_TOKEN} sh - #{}里的参数替换

mkdir -p ~/.kube

sudo ln -s /etc/rancher/k3s/k3s.yaml ~/.kube/config

sudo chmod 666 ~/.kube/config
```

3.**验证安装**（`master node`)：

```sh
kubectl get node #此时可以看到两个节点
```

**NOTE**:如果两个节点的HOSTNAME一样会导致server node安装失败。

4.**安装NFS**（`master_node`)

```sh
sudo apt update

sudo apt install nfs-kernel-server nfs-common -y

sudo mkdir -p /kubshare

sudo chown -R nobody:nogroup /kubshare

echo '/kubshare {MASTER_NODE_IP}/16(rw,sync,no_subtree_check,no_root_squash)' | sudo tee -a /etc/exports #{}里参数替换为MASTER_NODE_IP前两段 + .0.0

sudo systemctl enable nfs-kernel-server

sudo systemctl restart nfs-kernel-server
```

5.**安装NFS**（`server_node`)

```sh
sudo apt update

sudo apt install nfs-common -y
```

6.**安装helm**（`master_node`)

```sh
wget https://mirrors.huaweicloud.com/helm/v3.8.1/helm-v3.8.1-linux-amd64.tar.gz

tar -zxvf helm-v3.8.1-linux-amd64.tar.gz

sudo mv linux-amd64/helm /usr/local/bin/helm

ls /usr/local/bin/helm
```

7.**安装bitbro**（`master_node`)

*上传源码*：**bitbro-fabric-main.tar.gz**

```sh
tar zxvf bitbro-fabric-main.tar.gz

mv bitbro-fabric-main/ bitbro-fabric/

cd /bitbro-fabric/prod

sudo mkdir -p /kubshare/crypto/

sudo cp -R ../chaincode /kubshare/chaincodes

sudo cp -R scripts /kubshare/scripts

sudo cp -R crypto-config /kubshare/crypto/

sudo cp -R channel-artifacts /kubshare/crypto/

sudo chown -R nobody:nogroup /kubshare

cd /bitbro-fabric/prod/chart

helm install hlf-projectinfo . --set storage.nfs.host={MASTER_NODE_IP} --set storage.nfs.path="/kubshare" #{}里参数替换
```



8.**启用通道安装链码**

```sh
POD=$(k get po | grep cli | awk '{print $1}')

k exec -it $POD -- bash

bash cli.sh
```

9.**查看pod容器**

```sh
watch kubectl get pod #动态查看pod里所有的容器状态

kubectl describe pod <pod_name> #查看指定容器详情

kubectl logs -f pod <pod_name> #查看指定容器运行日志
```








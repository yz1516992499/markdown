<<<<<<< HEAD


###  合同流程相关

----

-----

#### **获取合同详情**

`getContractFabricDetail`

> 获取Fabric合同详情（合同 ID、当前用户、用户类型、合同签名参与者列表）
>
> 使用`webClientService`发起请求
>
> 将响应数据转换为 `ContractFabricAppDetailJsonView` 返回

------

#### **复制签署合同**

`contractCopySignedToPreviewWithNewName`

> 接受合同 ID
>
> 获取合同对象
>
> 将已签署的合同文件复制为新的预览文件
>
> 调用 `contractService` 保存合同对象（`contract`）

-------

#### **预览签名**

`previewSignByAdvisor`、`previewSignByFinder`、`previewSignByUplineFinder`

> 接收合同ID和签名照片
>
> 获取指定`id`和状态为`PREPARE`的合同信息
>
> 创建并初始化合同预览签名页面对象`ContractPreviewSignPageAppJsonView`
>
> 设置合同预览页面的各项属性，包括合同的基本信息和关联的加入请求信息
>
> 调用服务层的方法生成合同预览签名文件，并检查文件是否存在
>
> 如果文件存在，将其转换为PDF格式并发布转换事件，否则抛出文件未找到的异常

-------

#### **签名**

`signByAdvisor`

> 接收合同ID
>
> 获取当前登录用户信息
>
> 调用服务层方法，由Advisor签署合同（`signContractByAdvisor`）
>
> 创建签署合同记录（`sign_contract_record`)，发布相关事件（`PostRequestFabricCreateEvent`）
>
> 发布用户快照事件（`ApplicationUserSnapshotEvent`）
>
> 发布合同签署通知事件（`ContractSignedByAdvisorNotificationEvent`）
>
> 结束合同签署流程，保存合同（`contract`）

------

#### **Finder拒绝合同**

`rejectedByFinder`

> 接收合同ID和拒绝原因表单（`RejectContractForm`)
>
> 调用服务层方法拒绝合同（`rejectContract`）
>
> > 接受合同实体类（`entity`)
> >
> > 检查加入请求状态是否为`PENDING`和`ACTIVE`
> >
> > 更新合同状态到`INACTIVE`
> >
> > 保存合同记录
>
> 拒绝合同谈判记录（`rejectContractNegotiationRecord`)
>
> > 接收合同ID和拒绝原因表单（`RejectContractForm`)
> >
> > 获取合同谈判记录列表
> >
> > 如果是序列号为1且状态为`PROPOSED`，调用`rejectContractNegotiationRecord`方法处理拒绝操作，否则，直接调用`rejectContractNegotiationRecord`方法处理拒绝操作
>
> 发送包含拒绝理由和备注的通知邮件
>
> 结束合同签署流程（`endSigningProcess`)
>
> > 更新*`isInSigningProcess`* = *`false`*; *`signingProcessBy`* = *`null`*
> >
> > 保存合同记录
>
> 更新相关通知状态，并发布合同拒绝通知事件
>
> > 获取与当前合同相关的通知列表（`getNotificationList`)
> >
> > 更新每条通知状态，标记为只读（`updateNotification`)
> >
> > 发布`ContractRejectByFinderNotificationEvent`事件，包含合同拒绝通知的信息
> >
> > > 获取加入请求记录（`joinRequestRecord`)
> > >
> > > 过滤发送者，提取所有参与者
> > >
> > > 创建通知对象
> > >
> > > 如果为订阅者模式，则向所有参与者发送消息

-------

#### **Advisor保持原合同**

`keepByAdvisor`

> 保持合同（`keepContract`)
>
> > 检查合同状态（*`INACTIVE`*）
> >
> > 更新合同状态 （*`OPEN_FOR_SIGNAGE`*）
> >
> > 保存更新后的合同
> >
> > 更新通知（`updateNotification`)
> >
> > > 获取相关通知
> > >
> > > 更新通知为只读
>
> 保持合同协商记录（`keepContractNegotiationRecord`)
>
> > 获取合同协商记录列表
> >
> > 对协商记录列表进行处理
> >
> > >初始化*`sequence*`变量，值为列表数量加一
> > >
> > >过滤类型为*`NegotiationType.REJECTED.value`*的谈判记录
> > >
> > >对剩下的记录进行迭代，并用`keepContractNegotiationRecord2`方法更新记录，然后递增*`sequence`*
> > >
> > >> **接受合同协商记录实体（*`entity`*）和*`index`***
> > >>
> > >> 过滤状态（*`STATUS`*)是*`ACTIVE`*的合同协商记录
> > >>
> > >> 创建新的合同协商记录实体，*`sequence`*属性设置为*`index`*
> > >>
> > >> 保存新的合同协商记录
> > >
> > >对最后一条*`REJECTED`*状态的记录进行处理（`keepContractNegotiationRecord`）
> > >
> > >> 接受合同协商记录实体（*`entity`*）和*`index`*
> > >>
> > >> 过滤*`STATUS`*是*`ACTIVE`*并且*`NegotiationType`*是*`REJECTED`*的合同协商记录
> > >>
> > >> 创建新的合同协商记录实体
> > >>
> > >> > *`requesterUserId`* 设置为当前应用用户的实体 ID
> > >> >
> > >> > *`sequence`* 属性设置为原始记录的 *`sequence`* 加上传入的索引号 *`index`*
> > >> >
> > >> > *`type`* 设置为 *`NegotiationType.PROPOSED.value`*
> > >> >
> > >> > *`STATUS`*设置为*`Status.ACTIVE.value`*
> > >>
> > >> 保存新的合同协商记录
>
> 结束签署流程（`endSigningProcess`）
>
> > 更新*`isInSigningProcess`* = *`false`*; *`signingProcessBy`* = *`null`*
> >
> > 保存合同记录
>
> 触发合同保持通知事件（`ContractKeepNotificationEvent`)

----

-------



### 积分规则相关

----

--------

#### **登录/`LOGIN`**

`authorization`

> 获取系统设置的积分相关配置（`systemSettingService.getSystemSettingItemListBySystemSettingGroup`)
>
> 获取用户积分历史记录
>
> > 通过`applicationUserPointHistoryService.getApplicationUserPointHistoryList`获取用户的积分历史记录，*`eventType`* = *`LOGGING_IN`*
>
> 检查用户是否符合获得登录积分的条件
>
> > 检查用户是否没有登录积分历史记录，或者最后一次获得登录积分的时间是否超过系统设置的登录积分间隔天数，判断用户是否符合获得新的登录积分的条件
>
> 获取登录积分的数值
>
> > 通过`masterDataService.getMasterDataList`获取登录积分的数值，并将其格式化为*`BigDecimal`*类型
>
> 增加用户积分
>
> > 通过`applicationUserPointService.plusApplicationUserPoint`为用户增加积分
>
> 创建积分历史
>
> > 创建`CreateApplicationUserPointHistoryForm`对象
>
> 

-----

#### **项目方已批准投资者/`APPROVED BY ADVISOR`**	

------

#### **投资者已回复客户/`INVESTOR CONFIRMED`**

----

#### **投资者账户已支付/`INVESTOR MADE INVESTMENT`**

------

#### **投资者已签NDA/`INVESTOR SIGN NDA`**

------

#### **投资者已签意向书/`INVESTOR SIGNED MOU`**

----

#### **投资者已签投资条件书/`INVESTOR SIGNED TERM SHEET`**

----

#### **受邀兄弟赚取积分部分(1/x)/`INVITEE BRO EARN POINTS`**

-----

#### **已确认投资人数/`NUMBER OF INVESTOR CONFIRMED`**

-----

#### **NDA的投资者数量/`NUMBER OF INVESIOR SIGNED NDA`**

-----

#### 签署中间人协议名/`SIGNED FINDER AGREEMENT`

-----

#### **签署投资协议/`SIGNED INVESTMENT AGREEMENT`**

----



=======


###  合同流程相关

----

-----

#### **获取合同详情**

`getContractFabricDetail`

> 获取Fabric合同详情（合同 ID、当前用户、用户类型、合同签名参与者列表）
>
> 使用`webClientService`发起请求
>
> 将响应数据转换为 `ContractFabricAppDetailJsonView` 返回

------

#### **复制签署合同**

`contractCopySignedToPreviewWithNewName`

> 接受合同 ID
>
> 获取合同对象
>
> 将已签署的合同文件复制为新的预览文件
>
> 调用 `contractService` 保存合同对象（`contract`）

-------

#### **预览签名**

`previewSignByAdvisor`、`previewSignByFinder`、`previewSignByUplineFinder`

> 接收合同ID和签名照片
>
> 获取指定`id`和状态为`PREPARE`的合同信息
>
> 创建并初始化合同预览签名页面对象`ContractPreviewSignPageAppJsonView`
>
> 设置合同预览页面的各项属性，包括合同的基本信息和关联的加入请求信息
>
> 调用服务层的方法生成合同预览签名文件，并检查文件是否存在
>
> 如果文件存在，将其转换为PDF格式并发布转换事件，否则抛出文件未找到的异常

-------

#### **签名**

`signByAdvisor`

> 接收合同ID
>
> 获取当前登录用户信息
>
> 调用服务层方法，由Advisor签署合同（`signContractByAdvisor`）
>
> 创建签署合同记录（`sign_contract_record`)，发布相关事件（`PostRequestFabricCreateEvent`）
>
> 发布用户快照事件（`ApplicationUserSnapshotEvent`）
>
> 发布合同签署通知事件（`ContractSignedByAdvisorNotificationEvent`）
>
> 结束合同签署流程，保存合同（`contract`）

------

#### **Finder拒绝合同**

`rejectedByFinder`

> 接收合同ID和拒绝原因表单（`RejectContractForm`)
>
> 调用服务层方法拒绝合同（`rejectContract`）
>
> > 接受合同实体类（`entity`)
> >
> > 检查加入请求状态是否为`PENDING`和`ACTIVE`
> >
> > 更新合同状态到`INACTIVE`
> >
> > 保存合同记录
>
> 拒绝合同谈判记录（`rejectContractNegotiationRecord`)
>
> > 接收合同ID和拒绝原因表单（`RejectContractForm`)
> >
> > 获取合同谈判记录列表
> >
> > 如果是序列号为1且状态为`PROPOSED`，调用`rejectContractNegotiationRecord`方法处理拒绝操作，否则，直接调用`rejectContractNegotiationRecord`方法处理拒绝操作
>
> 发送包含拒绝理由和备注的通知邮件
>
> 结束合同签署流程（`endSigningProcess`)
>
> > 更新*`isInSigningProcess`* = *`false`*; *`signingProcessBy`* = *`null`*
> >
> > 保存合同记录
>
> 更新相关通知状态，并发布合同拒绝通知事件
>
> > 获取与当前合同相关的通知列表（`getNotificationList`)
> >
> > 更新每条通知状态，标记为只读（`updateNotification`)
> >
> > 发布`ContractRejectByFinderNotificationEvent`事件，包含合同拒绝通知的信息
> >
> > > 获取加入请求记录（`joinRequestRecord`)
> > >
> > > 过滤发送者，提取所有参与者
> > >
> > > 创建通知对象
> > >
> > > 如果为订阅者模式，则向所有参与者发送消息

-------

#### **Advisor保持原合同**

`keepByAdvisor`

> 保持合同（`keepContract`)
>
> > 检查合同状态（*`INACTIVE`*）
> >
> > 更新合同状态 （*`OPEN_FOR_SIGNAGE`*）
> >
> > 保存更新后的合同
> >
> > 更新通知（`updateNotification`)
> >
> > > 获取相关通知
> > >
> > > 更新通知为只读
>
> 保持合同协商记录（`keepContractNegotiationRecord`)
>
> > 获取合同协商记录列表
> >
> > 对协商记录列表进行处理
> >
> > >初始化*`sequence*`变量，值为列表数量加一
> > >
> > >过滤类型为*`NegotiationType.REJECTED.value`*的谈判记录
> > >
> > >对剩下的记录进行迭代，并用`keepContractNegotiationRecord2`方法更新记录，然后递增*`sequence`*
> > >
> > >> **接受合同协商记录实体（*`entity`*）和*`index`***
> > >>
> > >> 过滤状态（*`STATUS`*)是*`ACTIVE`*的合同协商记录
> > >>
> > >> 创建新的合同协商记录实体，*`sequence`*属性设置为*`index`*
> > >>
> > >> 保存新的合同协商记录
> > >
> > >对最后一条*`REJECTED`*状态的记录进行处理（`keepContractNegotiationRecord`）
> > >
> > >> 接受合同协商记录实体（*`entity`*）和*`index`*
> > >>
> > >> 过滤*`STATUS`*是*`ACTIVE`*并且*`NegotiationType`*是*`REJECTED`*的合同协商记录
> > >>
> > >> 创建新的合同协商记录实体
> > >>
> > >> > *`requesterUserId`* 设置为当前应用用户的实体 ID
> > >> >
> > >> > *`sequence`* 属性设置为原始记录的 *`sequence`* 加上传入的索引号 *`index`*
> > >> >
> > >> > *`type`* 设置为 *`NegotiationType.PROPOSED.value`*
> > >> >
> > >> > *`STATUS`*设置为*`Status.ACTIVE.value`*
> > >>
> > >> 保存新的合同协商记录
>
> 结束签署流程（`endSigningProcess`）
>
> > 更新*`isInSigningProcess`* = *`false`*; *`signingProcessBy`* = *`null`*
> >
> > 保存合同记录
>
> 触发合同保持通知事件（`ContractKeepNotificationEvent`)

----

-------



### 积分规则相关

----

--------

#### **登录/`LOGIN`**

`authorization`

> 获取系统设置的积分相关配置（`systemSettingService.getSystemSettingItemListBySystemSettingGroup`)
>
> 获取用户积分历史记录
>
> > 通过`applicationUserPointHistoryService.getApplicationUserPointHistoryList`获取用户的积分历史记录，*`eventType`* = *`LOGGING_IN`*
>
> 检查用户是否符合获得登录积分的条件
>
> > 检查用户是否没有登录积分历史记录，或者最后一次获得登录积分的时间是否超过系统设置的登录积分间隔天数，判断用户是否符合获得新的登录积分的条件
>
> 获取登录积分的数值
>
> > 通过`masterDataService.getMasterDataList`获取登录积分的数值，并将其格式化为*`BigDecimal`*类型
>
> 增加用户积分
>
> > 通过`applicationUserPointService.plusApplicationUserPoint`为用户增加积分
>
> 创建积分历史
>
> > 创建`CreateApplicationUserPointHistoryForm`对象
>
> 

-----

#### **项目方已批准投资者/`APPROVED BY ADVISOR`**	

------

#### **投资者已回复客户/`INVESTOR CONFIRMED`**

----

#### **投资者账户已支付/`INVESTOR MADE INVESTMENT`**

------

#### **投资者已签NDA/`INVESTOR SIGN NDA`**

------

#### **投资者已签意向书/`INVESTOR SIGNED MOU`**

----

#### **投资者已签投资条件书/`INVESTOR SIGNED TERM SHEET`**

----

#### **受邀兄弟赚取积分部分(1/x)/`INVITEE BRO EARN POINTS`**

-----

#### **已确认投资人数/`NUMBER OF INVESTOR CONFIRMED`**

-----

#### **NDA的投资者数量/`NUMBER OF INVESIOR SIGNED NDA`**

-----

#### 签署中间人协议名/`SIGNED FINDER AGREEMENT`

-----

#### **签署投资协议/`SIGNED INVESTMENT AGREEMENT`**

----



>>>>>>> cd253d1db690f0ce7d6e73b80c174a4abc819990
